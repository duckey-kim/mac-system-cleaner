{
  "_description": "macOS System Cleaner architecture reference for Claude Code",
  "entry_point": "run.py",
  "server": {
    "file": "app/server.py",
    "class": "Handler(http.server.BaseHTTPRequestHandler)",
    "type": "socketserver.ThreadingTCPServer",
    "port": {
      "default": 8787,
      "fallback": "auto-scan 8787..8807 via find_free_port()"
    },
    "threading": "each request in separate thread (daemon_threads=True)"
  },
  "api": {
    "GET /": {
      "handler": "_get_html()",
      "returns": "app/web/index.html (cached after first load)"
    },
    "GET /api/scan": {
      "handler": "scanner.scan_system()",
      "behavior": "reloads learned_folders.json before scan, parallel category scan",
      "returns": "{categories: [{id, name, total_size, group_count}], groups: [{label, path, category, items, total_size}], disk_info, tm_snapshots, total_cleanable}"
    },
    "GET /api/children": {
      "handler": "scanner.scan_children(path)",
      "params": {"path": "URL-encoded absolute path"},
      "security": "must start with HOME or /var/",
      "returns": "{children: [...], path: str}"
    },
    "GET /api/lookup": {
      "handler": "lookup.lookup_folder(name, path)",
      "params": {"name": "folder name", "path": "folder path"},
      "returns": "{desc, risk, source}"
    },
    "GET /api/check-update": {
      "handler": "updater.get_cached_result() || updater.check_update()",
      "returns": "{checked, has_update, latest_version, ...}"
    },
    "POST /api/delete": {
      "handler": "cleaner.delete_path(path, recreate, use_sudo)",
      "body": {"path": "str", "size": "int", "recreate": "bool", "use_sudo": "bool"},
      "security": "must start with HOME or /var/log",
      "side_effect": "history.record_delete(path, size, ok)",
      "returns": "{success, code, message}"
    },
    "GET /api/tm-snapshots": {
      "handler": "tm_manager.list_snapshots() + get_snapshots_size()",
      "returns": "{snapshots: [{date, display}], count, size_bytes, size_formatted}"
    },
    "POST /api/tm-delete": {
      "handler": "tm_manager.delete_snapshot(date) or delete_all_snapshots()",
      "body": {"date": "str (date or '__all__')"},
      "returns": "{success, message} or {success, deleted, failed, message}"
    },
    "GET /api/history": {
      "handler": "history.get_history(limit) + get_stats()",
      "params": {"limit": "int (default 50)"},
      "returns": "{records: [{path, name, size, success, timestamp, size_formatted, time_ago}], stats: {total_deleted, total_size, ...}}"
    },
    "GET /api/update-status": {
      "handler": "updater.get_download_status()",
      "returns": "{status, progress, ...}"
    },
    "POST /api/do-update": {
      "handler": "updater.do_update() in daemon thread",
      "returns": "{started, message}"
    }
  },
  "components": {
    "config": {
      "file": "app/config.py",
      "exports": ["VERSION", "GITHUB_REPO", "PORT", "HOME", "KNOWN_FOLDERS", "LEARNED_PATH", "reload_folders()", "get_folder_info(name)"],
      "data_source": "app/learned_folders.json"
    },
    "scanner": {
      "file": "app/scanner.py",
      "exports": ["scan_system()", "scan_children(path)", "_scan_library()", "_scan_simple_dir()", "_scan_dev_caches()", "_scan_downloads()", "_scan_trash()", "_scan_media()", "_scan_system_logs()"],
      "mechanism": "du via subprocess, ThreadPoolExecutor(max_workers=6) for parallel category scan",
      "categories": [
        {"id": "app_data", "name": "앱 데이터 (~/Library)", "scan": "du -d2 ~/Library", "min_group_mb": 50, "min_item_mb": 20},
        {"id": "dev_cache", "name": "개발자 캐시", "scan": "du -d1 per dotfile dir", "paths": ["~/.npm", "~/.gradle", "~/.m2", "~/.docker", "~/.pub-cache", "~/.cocoapods", "~/.cargo", "~/.rustup", "~/.gem", "~/.composer", "~/.nuget", "~/.conda", "~/.nvm", "~/.pyenv", "~/.rbenv", "~/.yarn", "~/.pnpm-store"], "min_mb": 10},
        {"id": "downloads", "name": "다운로드 폴더", "scan": "du -d1 ~/Downloads", "min_mb": 20},
        {"id": "trash", "name": "휴지통", "scan": "du -d1 ~/.Trash", "min_mb": 1},
        {"id": "media", "name": "대용량 미디어", "scan": "du -d1 ~/Movies, ~/Music", "min_mb": 50},
        {"id": "system_logs", "name": "시스템 로그", "scan": "du -d1 /var/log", "min_mb": 5}
      ],
      "response_structure": "categories[] + groups[] (each group has category field)"
    },
    "cleaner": {
      "file": "app/cleaner.py",
      "exports": ["delete_path(path, recreate, use_sudo)"],
      "strategies": {
        "normal": "shutil.rmtree",
        "sudo": "sudo -n rm -rf (cached) → osascript prompt (fallback)"
      },
      "recreate_option": "deletes then recreates empty directory for app compatibility"
    },
    "lookup": {
      "file": "app/lookup.py",
      "exports": ["lookup_folder(name, path)"],
      "lookup_chain": [
        "1. learned_folders.json (permanent store, 41 entries)",
        "2. ~/.mac_cleaner_cache.json (session cache)",
        "3. pattern matching (bundle IDs: com.apple.*, keywords: cache/log/node_modules)",
        "4. DuckDuckGo API (no key required)"
      ],
      "auto_save": "results saved back to learned_folders.json and cache"
    },
    "updater": {
      "file": "app/updater.py",
      "exports": ["check_update()", "get_cached_result()", "check_update_background(delay)", "do_update()", "get_download_status()"],
      "mechanism": "GitHub API → latest release check + learned_folders.json remote merge",
      "github_repo": "duckey-kim/mac-system-cleaner"
    },
    "tm_manager": {
      "file": "app/tm_manager.py",
      "exports": ["list_snapshots()", "delete_snapshot(date_str)", "delete_all_snapshots()", "get_snapshots_size()"],
      "mechanism": "tmutil/diskutil subprocess calls with timeout",
      "sudo_pattern": "sudo -n (cached) → osascript with administrator privileges (fallback)",
      "security": "shlex.quote() for shell injection prevention"
    },
    "history": {
      "file": "app/history.py",
      "exports": ["record_delete(path, size, success)", "get_history(limit)", "get_stats()"],
      "storage": "~/.mac_cleaner_history.json",
      "thread_safety": "threading.Lock() for all read/write operations",
      "limits": "FIFO 500 records max"
    },
    "frontend": {
      "file": "app/web/index.html",
      "type": "single-file SPA (HTML + CSS + JS inline)",
      "features": ["dark theme", "category-based scan view", "collapsible category sections", "infinite drill-down", "batch select/delete", "sudo modal", "real-time scan updates", "TM snapshot management", "one-click safe clean", "delete history"],
      "communication": "fetch API to backend JSON endpoints"
    }
  },
  "data": {
    "learned_folders.json": {
      "path": "app/learned_folders.json",
      "format": {"<lowercase_folder_name>": {"desc": "string", "risk": "safe|moderate|caution"}},
      "special_key": "_comment (stripped on load)",
      "count": "~90 predefined entries",
      "categories": ["Xcode", "Android Studio", "Flutter", "Node.js", "Homebrew", "Docker", "JetBrains", "VS Code"]
    },
    "cache_file": {
      "path": "~/.mac_cleaner_cache.json",
      "purpose": "temporary lookup results between sessions"
    },
    "history_file": {
      "path": "~/.mac_cleaner_history.json",
      "purpose": "delete operation history (FIFO 500 records)",
      "format": "[{path, name, size, success, timestamp}, ...]"
    }
  },
  "build": {
    "script": "build_app.sh",
    "steps": [
      "1. verify Python 3 + pip",
      "2. install PyInstaller if missing",
      "3. generate PNG icons via pure Python (struct + zlib)",
      "4. convert PNG → ICNS via iconutil",
      "5. PyInstaller --onefile --windowed with --add-data for html and json",
      "6. output: dist/System Cleaner.app"
    ],
    "bundle_id": "com.syscleaner.macos",
    "add_data": [
      "app/web/index.html:app/web",
      "app/learned_folders.json:app"
    ]
  }
}
