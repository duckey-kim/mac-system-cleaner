{
  "_description": "Coding conventions, patterns, and gotchas for macOS System Cleaner",
  "language": {
    "backend": "Python 3.8+, stdlib only (no pip packages at runtime)",
    "frontend": "Vanilla JS/CSS, no framework, no build step",
    "comments": "Korean (한국어)",
    "docstrings": "Korean (한국어)"
  },
  "pyinstaller_compat": {
    "description": "All file path resolution must handle both dev and frozen (bundled) modes",
    "pattern": {
      "check": "getattr(sys, 'frozen', False)",
      "dev_base": "os.path.dirname(os.path.abspath(__file__))",
      "frozen_base": "sys._MEIPASS (for --add-data resources) or os.path.dirname(sys.executable) (for writable files)",
      "affected_files": ["app/config.py (_get_learned_path)", "app/server.py (_load_html)"]
    },
    "important": "learned_folders.json uses sys.executable base (writable), index.html uses _MEIPASS (read-only)"
  },
  "security_constraints": {
    "path_whitelist": {
      "scan/children": "path must start with HOME or /var/",
      "delete": "path must start with HOME or /var/log (stricter)"
    },
    "sudo_handling": "never store passwords; use osascript for native macOS prompt"
  },
  "error_handling_patterns": {
    "BrokenPipeError": "silently caught in Handler.handle() — browser may close connection early",
    "delete_failures": "return (success: bool, code: str, message: str) tuple, never raise",
    "scan_errors": "individual path failures don't break overall scan (parallel executor)",
    "subprocess_safety": "always wrap subprocess.run with (TimeoutExpired, FileNotFoundError, OSError) catch"
  },
  "performance_patterns": {
    "du_optimization": "single 'du -d2 -k' for ~/Library, 'du -d1 -k' for other categories",
    "parallel_scan": "ThreadPoolExecutor(max_workers=6) for 6 category scans in parallel",
    "category_scan": "each category returns list[dict] of groups; scan_system() merges and orders by CATEGORY_ORDER",
    "html_caching": "_HTML_CACHE loaded once, served from memory",
    "lookup_batching": "web lookups batched 4 at a time"
  },
  "data_conventions": {
    "folder_key_format": "always lowercase (e.g., 'deriveddata', not 'DerivedData')",
    "risk_levels": ["safe (auto-regenerated: caches, builds)", "moderate (reinstall needed: packages)", "caution (data loss possible: backups, projects)"],
    "size_unit": "scanner returns bytes as int, frontend formats to human-readable"
  },
  "frontend_patterns": {
    "api_communication": "all via fetch() with JSON responses",
    "drill_down": "recursive: click folder → GET /api/children → render subtree → repeat",
    "deletion_flow": "checkbox select → confirm modal → POST /api/delete per item → refresh sizes",
    "sudo_flow": "first try normal delete → if permission error, show sudo modal → retry with use_sudo=true"
  },
  "thread_safety_patterns": {
    "history_module": "threading.Lock() protects all file read/write to ~/.mac_cleaner_history.json",
    "rule": "any shared mutable state (file or in-memory) must be protected with a lock"
  },
  "sudo_escalation_pattern": {
    "description": "2-stage sudo for macOS: try cached sudo first, then GUI prompt",
    "stage1": "sudo -n (non-interactive, uses cached credentials)",
    "stage2": "osascript 'do shell script ... with administrator privileges' (native password dialog)",
    "used_in": ["app/cleaner.py", "app/tm_manager.py"],
    "security": "shlex.quote() for all user-provided strings in shell commands"
  },
  "gotchas": [
    "PORT is defined in config.py but server.py uses find_free_port() which may pick a different port",
    "reload_folders() is called on every /api/scan to pick up newly learned folder info",
    "learned_folders.json is both bundled (read at startup) and writable (lookup saves new entries)",
    "_comment key in learned_folders.json is intentionally stripped on load",
    "server uses os._exit(0) on KeyboardInterrupt for clean shutdown of all daemon threads",
    "history file (~/.mac_cleaner_history.json) is FIFO capped at 500 records to prevent unbounded growth",
    "TM snapshot size estimation falls back from tmutil → diskutil if first method returns 0",
    "POST /api/delete now records deletion to history (side effect added in v1.1.0)",
    "scan_system() returns 'categories' array for frontend sectioning; groups have 'category' field",
    "empty categories (total_size=0) are excluded from the categories array",
    "frontend render() uses renderGroup() helper for both flat and categorized views"
  ]
}
